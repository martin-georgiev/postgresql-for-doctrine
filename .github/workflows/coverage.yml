name: Coverage

on:
  workflow_run:
    workflows: ["Integration Tests", "Unit Tests"]
    types: [completed]
  workflow_dispatch:

jobs:
  finalize:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - id: check
        uses: actions/github-script@v7
        with:
          script: |
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: context.payload.workflow_run?.head_sha || context.sha,
              status: 'completed',
              per_page: 100
            });

            const bothComplete = ['Integration Tests', 'Unit Tests'].every(name =>
              workflows.data.workflow_runs.some(
                run => run.name === name && run.conclusion === 'success'
              )
            );

            core.info(bothComplete ? 'Both workflows completed successfully.' : 'Waiting for other workflow to complete.');
            core.setOutput('ready', String(bothComplete));

      - if: ${{ steps.check.outputs.ready == 'true' }}
        name: Finalize coverage report
        uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          parallel-finished: true
          carryforward: "Unit,Integration"
