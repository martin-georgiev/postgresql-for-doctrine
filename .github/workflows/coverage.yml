name: Coverage

on:
  workflow_run:
    workflows: ["Integration Tests", "Unit Tests"]
    types: [completed]
  # Also allow manual triggering for debugging
  workflow_dispatch:

jobs:
  finalize:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    # Needed for listWorkflowRunsForRepo and safe defaults for token scope
    permissions:
      actions: read
      contents: read
      statuses: write
    # Prevent multiple concurrent finalizers for the same commit
    concurrency:
      group: coverage-${{ github.event.workflow_run.head_sha }}
      cancel-in-progress: true
    steps:
      - id: check
        uses: actions/github-script@v7
        with:
          script: |
            // For manual dispatch, use the current SHA, otherwise use the triggering workflow's SHA
            const targetSha = context.payload.workflow_run?.head_sha || context.sha;
            
            const workflows = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head_sha: targetSha,
              status: 'completed',
              per_page: 100
            });

            const bothComplete = ['Integration Tests', 'Unit Tests'].every(name =>
              workflows.data.workflow_runs.some(
                run => run.name === name && run.conclusion === 'success'
              )
            );

            // Debug information
            core.info(`Found ${workflows.data.workflow_runs.length} workflow runs for SHA ${targetSha}`);
            workflows.data.workflow_runs.forEach(run => {
              core.info(`- ${run.name}: ${run.conclusion} (${run.status})`);
            });

            core.info(bothComplete ? 'Both workflows completed successfully.' : 'Waiting for other workflow to complete.');
            core.setOutput('ready', String(bothComplete));

      - if: ${{ steps.check.outputs.ready == 'true' }}
        uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          parallel-finished: true
          carryforward: "Integration,Unit"
          # Pass the original commit SHA and PR context to maintain consistency
          git-commit: ${{ github.event.workflow_run.head_sha || github.sha }}
          git-branch: ${{ github.event.workflow_run.head_branch || github.ref_name }}
          service-number: ${{ github.event.workflow_run.id || github.run_id }}
          pull-request: ${{ github.event.workflow_run.pull_requests[0].number || github.event.pull_request.number || '' }}
